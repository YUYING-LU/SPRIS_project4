---
title: "Project 4"
author: "Yuying Lu"
date: "2025-04-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
```


# Main Objectives

- a) Comprehensive statistical analysis
  - 1) Randomization procedure
  - 2) Analytic approach for primary analysis
  - 3) Sample size calculation
  
- b) Whether the vaccine group has greater odds of having SAE at any of the three assessment time points

- c) Other Interests
  - 1) Probability of getting infected within 12 months with corresponding 95% confidence interval 
  - 2) Median time to infection, and the mean of the time to infection after the second shot


```{r}
library(tidyverse)
library(lme4)
library(lmerTest)
library(readxl)
library(ggplot2)
library(emmeans)
library(glmmTMB)

df_Q2bBL <- read_excel("Q2b_BL.xlsx") |> 
  janitor::clean_names()
df_Q2b <- read_excel("Q2b.xlsx")|> 
  janitor::clean_names()
df_Q2c <- read_excel("Q2c.xlsx", col_types = c("numeric", "numeric", "numeric","numeric", "numeric"))|> 
  janitor::clean_names()
```

## a)


## b) 

```{r}
df_b <- left_join(df_Q2bBL, df_Q2b, by = "id")
df_b
```


```{r}
tab <- df_b %>%
       group_by(time, group) %>%
       summarise(n = n(),
                 sae = sum(sae, na.rm = T),
                 risk = sae / n,
                 .groups = "drop")

print(tab)
```

### Logistic Mixed Effect Model 


Add site as random intercept

```{r}
SAE_mod = df_b |> mutate(time = as.factor(time)) |> 
                glmmTMB(sae ~ sex + age + time + group + (1 | id),
                              data = _, family = binomial)
summary(SAE_mod)
```



```{r}
m1 <- df_b |> glmer(sae ~ sex + age + time + group + (1 | id),
            family = binomial(link = "logit"), 
            data   = _)

summary(m1)
```


```{r}
SAE_mod = df_b |>
                glmmTMB(sae ~ sex + age + time + group + (1 | id),
                              data = _, family = binomial)
summary(SAE_mod)
```

### GEE ? Sensitivity Analysis

```{r}
library(geepack)
gee <- geeglm(sae ~ group * time + sex + age,
              id      = id,
              family  = binomial,
              corstr  = "exchangeable",
              data    = df_b)

summary(gee)
```

```{r}
library(emmeans)

emm <- emmeans(gee, ~ group | time, type = "response")
pairs(emm, by = "time")  # gives OR and 95% CI
```

## c) 

```{r}
df_Q2c[1287,]
```

```{r}
df_c = left_join(df_Q2c, df_Q2bBL, by = "id")
df_c
```

```{r}
mean(df_c$infection_time, na.rm = T)

mean(is.na(df_c$infection_time))
```


### KM 

```{r}
library(survival)
library(survminer)
library(patchwork)
#library(pec)
#library(rms)
df_surv =  df_c |> 
       mutate(time = ifelse(infection == 1, infection_time,last_fu_time),
              status = infection)

km  <- survfit(Surv(enrollment_time, time, status) ~ 1, data = df_surv)
plot(km)
ggsurvplot(km, conf.int = T, data = df_surv, pval = TRUE, ggtheme = theme_minimal(),
           title = "KM Survival Curves")
# S(365) is KM survival prob at 12 months; 1‑S is infection probability

prob12 <- 1 - summary(km, times = 365)$surv
ci12   <- c(1 - summary(km, times = 365)$upper, 1 - summary(km, times = 365)$lower)

cat(sprintf("Probability of infection within 12 months = %.2f%% (95%% CI %.2f – %.2f%%)\n",
            100*prob12, 100*ci12[2], 100*ci12[1]))
```

```{r}
cox_mod<- coxph(Surv(enrollment_time, time, status) ~ sex + age , data = df_surv)
# Print summary of the model
summary(cox_mod)
cox.zph(cox_mod)
```
```{r}
summary(df_c)
```

